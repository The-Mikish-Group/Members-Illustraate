@using Microsoft.AspNetCore.Identity
@using Members.Services
@inject SignInManager<IdentityUser> SignInManager
@inject UserManager<IdentityUser> UserManager
@inject ITaskManagementService TaskService

@{
    bool shouldShowBanner = false;
    int overdueCount = 0;
    int dueNowCount = 0;

    if (SignInManager.IsSignedIn(User) && (User.IsInRole("Admin") || User.IsInRole("Manager")))
    {
        var userId = UserManager.GetUserId(User);
        if (!string.IsNullOrEmpty(userId))
        {
            shouldShowBanner = await TaskService.ShouldShowTaskReminderAsync(userId);
            if (shouldShowBanner)
            {
                var tasks = await TaskService.GetCurrentTaskStatusAsync();
                overdueCount = tasks.Count(t => t.ComputedStatus == "Overdue");
                dueNowCount = tasks.Count(t => t.ComputedStatus == "Due Now");
            }
        }
    }
}

@if (shouldShowBanner && (overdueCount > 0 || dueNowCount > 0))
{
    <div class="alert bg-warning alert-dismissible fade show mt-4 mb-0 border-0 rounded-0" role="alert" id="taskReminderBanner">
        <div class="container-fluid">
            <div class="row align-items-center">
                <div class="col-auto">
                    <i class="bi bi-exclamation-triangle-fill fs-4"></i>
                </div>
                <div class="col">
                    <h6 class="alert-heading mb-1">
                        <i class="bi bi-list-task"></i> Administrative Tasks Need Attention
                    </h6>
                    <p class="mb-0 small">
                        @if (overdueCount > 0)
                        {
                            <span class="badge bg-danger me-2">@overdueCount Overdue</span>
                        }
                        @if (dueNowCount > 0)
                        {
                            <span class="badge bg-warning text-dark me-2">@dueNowCount Due Now</span>
                        }
                        Please review and complete pending tasks to keep operations running smoothly.
                    </p>
                </div>
                <div class="col-auto">
                    <a href="/Admin/TaskManagement" class="btn btn-warning btn-sm me-2">
                        <i class="bi bi-arrow-right"></i> View Tasks
                    </a>
                </div>
            </div>
        </div>
        <button type="button" class="btn-close" aria-label="Close" onclick="dismissTaskReminder()"></button>
    </div>

    <script>
        async function dismissTaskReminder() {
            try {
                // Get anti-forgery token
                const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value || '';

                // Make AJAX call to dismiss the reminder
                const response = await fetch('/Admin/TaskManagement?handler=DismissReminder', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'RequestVerificationToken': token
                    },
                    body: `__RequestVerificationToken=${encodeURIComponent(token)}`
                });

                if (response.ok) {
                    // Hide the banner with animation
                    const banner = document.getElementById('taskReminderBanner');
                    if (banner) {
                        banner.classList.remove('show');
                        setTimeout(() => {
                            banner.style.display = 'none';
                        }, 150);
                    }
                } else {
                    console.error('Failed to dismiss task reminder');
                }
            } catch (error) {
                console.error('Error dismissing task reminder:', error);
                // Fallback: still hide the banner locally
                const banner = document.getElementById('taskReminderBanner');
                if (banner) {
                    banner.style.display = 'none';
                }
            }
        }
    </script>
}